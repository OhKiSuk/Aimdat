{% extends 'base.html' %}
{% load static %}
{% load get_attr %}
{% block style %}
<link rel="style" href="{% static 'js/jquery-ui.min.css' %}">
{% endblock %}
{% block content %}
<form method="POST" action="{% url 'services:analysis' %}" class="p-0 m-0">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center my-5 py-3">
        <div class="d-flex col-10">
            <b class="d-flex align-items-center" style="width:23%;"><span class="font-lg">검색결과</span><span class="mx-2 font-md">총 {{paginator.count}}건</span></b>
            <div class="applied_filter_list d-flex align-items-center" style="overflow-x: auto; white-space: nowrap;">
                {% if corp %}
                <span class="badge text-bg-primary mx-1">기업명:{{corp}}</span>
                {% endif %}
                {% for data in applied_filter_list%}
                <span class="badge text-bg-primary mx-1">{{data.1}}:{{data.2}}~{{data.3}}</span>
                {% endfor %}
            </div>
        </div>
        <div>
            <button type="submit" class="btn btn-primary mx-1">기업분석</button>
            <button type="button" class="filter_set btn btn-primary" data-bs-toggle="modal" data-bs-target="#filter-modal">필터설정</button>
        </div>
    </div>
    <table class="table table-hover align-middle font-sm text-center" id="table">
        <thead>
            <tr class="bg-sub fw-bold" style="color: white;">
                <th style="width:5%">No.</th>
                <th style="width:15%">회사명</th>
                {% for data in table_column %}
                <th>{{data}}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for obj in object_list %}
            <tr>
                <td>{{page_obj.start_index|add:forloop.counter0}}</td>
                <td class="d-flex flex-wrap justify-content-start">
                    <div class="d-flex align-items-center col-12"><input id="tooltip" type="checkbox" name="checked_corp" value="{{obj.corp_id}}, {{obj.year}}, {{obj.quarter}}" data-toggle="tooltip" data-placement="top" title="비교할 기업을 선택하세요."><a href="{% url 'services:detail' obj.corp_id %}" class="text-decoration-none" style="color:black;">{{obj.corp_id_id__corp_name}}</a></div>
                    <span class="badge text-bg-primary" style="margin-right: 1%;">{{obj.corp_id_id__corp_country}}</span>
                    <span class="badge text-bg-primary" style="margin-right: 1%;">{{obj.corp_id_id__corp_market}}</span>
                    <span class="badge text-bg-primary">{{obj.corp_id_id__corp_sectors}}</span>
                </td>
                {% for field in fields %}
                <td>{{obj|get_attr:field}}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</form>
<div class="paging m-3">
    <ul class="pagination justify-content-center pagination-sm">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">이전</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <a class="page-link" tabindex="-1" aria-disabled="true" href="#">이전</a>
        </li>
        {% endif %}
        {% for page_number in page_obj.paginator.page_range %}
        {% if page_number >= page_obj.number|add:-5 and page_number <= page_obj.number|add:5 %}
        {% if page_number == page_obj.number %}
        <li class="page-item active" aria-current="page">
            <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
        </li>
        {% else %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
        </li>
        {% endif %}
        {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">다음</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <a class="page-link" tabindex="-1" aria-disabled="true" href="#">다음</a>
        </li>
        {% endif %}
    </ul>
</div>
{% include 'includes/footer.html' %}
</div>
<div class="modal modal-lg" id="filter-modal" tabindex="-1" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header d-flex mx-3">
                <div class="modal-title font-md my-3"><b>필터설정</b></div>
                <div class="setting_filter_list mx-3"></div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body font-sm d-flex">
                <div class="modal-side col-3 my-3">
                    <ul class="list-group" role="tablist" style="list-style: none;">
                        <li class="dropdown text-center" role="presentation">
                            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-offset="0,3"  aria-expanded="false" style="width: 160px;">지표선택 </button>
                            <ul class="dropdown-menu text-center">
                                <li class="drop-item">
                                    <button class="dropdown-item active font-sm py-2" id="fs_tab" data-bs-toggle="tab" data-bs-target="#item_fs" type="button" role="tab" aria-controls="fs_item" aria-selected="true" tabindex="0">
                                    재무지표
                                    </button>
                                </li>
                                <li class="drop-item">
                                    <button class="dropdown-item font-sm py-2" id="rsi_tab" data-bs-toggle="tab" data-bs-target="#item_rsi" type="button" role="tab" aria-controls="rsi_item" aria-selected="false" tabindex="1">
                                    투자지표
                                    </button>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <div class="tab-content my-3" id="content" style="overflow-y: scroll; height: 150px;">
                        <div class="tab-pane active" id="item_fs" role="tabpanel" aria-labelledby="fs_tab">
                            <ul class="filter_items list-group text-center" style="list-style: none; width: 85%; margin-left: auto; margin-right: auto;">
                                {% for data in filter_item_fs %}
                                <li class="{{data.0}} filter_item list-group-item list-group-item-action mx-1" >{{data.1}}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="tab-pane" id="item_rsi" role="tabpanel" aria-labelledby="rsi_tab">
                            <ul class="filter_items list-group text-center" style="list-style: none; width: 85%; margin-left: auto; margin-right: auto;">
                                {% for data in filter_item_rsi %}
                                <li class="{{data.1}} filter_item list-group-item list-group-item-action mx-1">{{data.0}}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <form method="POST" class="fitler_data col-9 d-flex flex-wrap align-items-center align-content-between my-3">
                    {% csrf_token %}
                    <div class="d-flex align-items-center col-12">
                        <div class="d-flex mx-4">
                            <div class="input-group">
                                <input type="text" id="year" name="year" class="form-control text-center font-sm" aria-label="Text input with dropdown button" placeholder="년도">
                                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-offset="-2,3" aria-expanded="false" ></button>
                                <ul class="dropdown-menu dropdown-menu-end text-center year">
                                    <li><a class="dropdown-item font-sm" data-value="2020" href="#">2020</a></li>
                                    <li><a class="dropdown-item font-sm" data-value="2021" href="#">2021</a></li>
                                    <li><a class="dropdown-item font-sm" data-value="2022" href="#">2022</a></li>
                                    <li><a class="dropdown-item font-sm" data-value="2023" href="#">2023</a></li>
                                </ul>
                            </div>
                            <div class="input-group mx-2">
                                <input type="text" id="quarter" name="quarter" class="form-control text-center font-sm" aria-label="Text input with dropdown button" placeholder="분기">
                                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-offset="-2,3" aria-expanded="false"></button>
                                <ul class="dropdown-menu dropdown-menu-end text-center quarter">
                                    <li><a class="dropdown-item font-sm" data-value="1분기" href="#">1분기</a></li>
                                    <li><a class="dropdown-item font-sm" data-value="2분기" href="#">2분기</a></li>
                                    <li><a class="dropdown-item font-sm" data-value="3분기" href="#">3분기</a></li>
                                    <li><a class="dropdown-item font-sm" data-value="4분기" href="#">4분기</a></li>
                                </ul>
                            </div>
                            <input class="form-control text-center font-sm" id="search_input" name="corp" type="text" placeholder="기업명">
                            <div id="search_results"></div>
                        </div>
                    </div>
                    {% for data in input_item_fs %}
                    <div class="{{data.0}}_toggle input_data" style="display: none;">
                        <div class="d-flex col-12 align-items-center mt-4">
                            <div class="{{data.0}} text-center" style="width:170px;">{{data.1}}</div>
                            <input type="text" name="{{data.0}}_min" class="{{data.0}}_min form-control form-control-sm text-center" style="width:130px;">
                            <span class="mx-3"> ~ </span>
                            <input type="text" name="{{data.0}}_max" class="{{data.0}}_max form-control form-control-sm text-center" style="width:130px;">
                            <button type="button" class="{{data.0}} btn btn-primary btn-sm add-filter mx-3">추가</button>
                        </div>
                    </div>
                    {% endfor %}
                    {% for data in input_item_rsi %}
                    <div class="{{data.1}}_toggle input_data" style="display: none;">
                        <div class="d-flex col-12 align-items-center mt-4">
                            <span class="{{data.1}} text-center" style="width:170px;">{{data.0}}</span>
                            <input type="text" name="{{data.1}}_min" class="{{data.1}}_min form-control form-control-sm text-center" style="width:130px;">
                            <span class="mx-3"> ~ </span>
                            <input type="text" name="{{data.1}}_max" class="{{data.1}}_max form-control form-control-sm text-center" style="width:130px;">
                            <button type="button" class="{{data.1}} btn btn-primary btn-sm add-filter mx-3">추가</button>
                        </div>
                    </div>
                    {% endfor %}
                    <button class="btn btn-primary btn-sm submit" type="submit" style="position: relative; top: -10%; left: 85%;">완료</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script src="{% static 'js/search_view.js' %}"></script>
<script src="{% static 'js/datatables.min.js' %}"></script>
<script src="{% static 'js/jquery-ui.min.js' %}"></script>
<script>
{% if year %}
$('#year').val('{{year}}')
{% endif %}

{% if quarter %}
$('#quarter').val('{{quarter}}분기')
{% endif %}

{% for data in applied_input_data %}
$('.{{data.0}}_min').val('{{data.1}}');
$('.{{data.0}}_max').val('{{data.2}}');
{% endfor %}

{% if corp %}
var set_filter = $('<span>', {
    name: 'corp',
    value: '{{corp}}',
    class: 'setting_filter badge text-bg-primary mx-1',
    text: '기업명:{{corp}}',
    click: remove_corp
});
$(".setting_filter_list").append(set_filter);
$("#search_input").val('{{corp}}')
{% endif %}

{% for data in applied_filter_modal%}
var set_filter = $('<span>', {
    class: '{{data.0}} setting_filter badge text-bg-primary mx-1',
    text: '{{data.1}}:{{data.2}}~{{data.3}}',
    click: remove_filter
});
$('.setting_filter_list').append(set_filter);
{% endfor %}



$('#table').DataTable({
    searching: false,
    paging: false,
    language: {
        info: '',
        infoEmpty: '',
        zeroRecords: '검색된 데이터가 없습니다.',
    },
});

{% with corp_name as name %}
var availableTags = {{name|safe}};
$("#search_input").autocomplete({
    source: availableTags,
    appendTo: "#search_results",
    messages: {
        noResults: '',
        results: function() {}
    },
    focus: function(event, ui) {
        $("#search_input").val(ui.item.label);
        return false;
    },
    select: function(event, ui) {
        $("#search_input").val(ui.item.label);
        return false;
    }
}).autocomplete("instance")._renderItem = function(ul, item) {
    return $("<li>")
        .addClass("dropdown-item select_corp")
        .append("<div>" + item.label + "</div>")
        .appendTo(ul)
        .on("mouseenter", function() {
            $(this).siblings().removeClass("ui-state-active");
            $(this).addClass("ui-state-active");
        })
        .on("click", function() {
            $(this).addClass("ui-state-active");
            $(this).parent().siblings("input").val($(this).text());
            var name = $("span[name='corp']").text();
            if (name == '') {
                var set_filter = $('<span>', {
                    name: 'corp',
                    value: item.label,
                    class: 'setting_filter badge text-bg-primary mx-1',
                    text: '기업명:' + item.label,
                    click: remove_corp
                });
                $(".setting_filter_list").append(set_filter)
            } else if (name != "기업명:" + item.label) {
                if (confirm('검색 기업을 변경하시겠습니까?')) {
                    $("span[name='corp']").remove();
                    var set_filter = $('<span>', {
                        name: 'corp',
                        value: item.label,
                        class: 'setting_filter badge text-bg-primary mx-1',
                        text: '기업명:' + item.label,
                        click: remove_corp
                    });
                    $(".setting_filter_list").append(set_filter);
                }
            }
        });
};

$("#search_input").autocomplete("instance").menu.element.addClass("dropdown-menu");
{% endwith %}
</script>
{% endblock %}